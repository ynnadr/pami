<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAMI Thursday Walk - Karet Bivak</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { display: flex; flex-direction: column; height: 100vh; padding: 0; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #header { background-color: #f8f8f8; padding: 15px 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; flex-shrink: 0; }
        #header h1 { margin: 0 0 5px 0; font-size: 1.4em; color: #2c3e50; }
        #header p { margin: 0 0 3px 0; font-size: 0.9em; color: #7f8c8d; }
        #totalRouteLength { font-weight: bold; color: #e67e22; }
        #map { flex-grow: 1; width: 100vw; z-index: 1; background-color: #e0e0e0; }
        .leaflet-tooltip { background-color: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); font-weight: bold; padding: 6px 10px; }
        .leaflet-control-custom button { background-color: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 30px; height: 30px; font-size: 1.4em; line-height: 26px; text-align: center; cursor: pointer; }
        .leaflet-control-custom button:hover { background-color: #f4f4f4; }
    </style>
</head>
<body>

    <div id="header">
        <h1>PAMI Thursday Walk</h1>
        <p>11 September 2025 - Start at 7:30am</p>
        <p>Total route (est): <span id="totalRouteLength">Menghitung...</span> km.</p>
    </div>
    <div id="map"></div>

    <script>
        // Data GeoJSON (dipersingkat untuk kemudahan membaca)
        const geojsonData = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Pintu belakang TPU Karet Bivak","marker-color":"#ff0000"},"geometry":{"coordinates":[106.813687,-6.20465],"type":"Point"}},{"type":"Feature","properties":{"name":"Rute 3","stroke":"#808000","stroke-width":5},"geometry":{"type":"LineString","coordinates":[[106.815989,-6.200866],[106.81516,-6.200669],[106.815189,-6.201403],[106.815307,-6.201449],[106.815404,-6.201531],[106.815465,-6.201641],[106.815999,-6.203356],[106.815773,-6.203378],[106.815561,-6.203375]]}},{"type":"Feature","properties":{"name":"Gerbang TPU Karet Bivak","marker-color":"#ff0000"},"geometry":{"coordinates":[106.815669,-6.203325],"type":"Point"}},{"type":"Feature","properties":{"name":"FINISH: Stasiun Karet"},"geometry":{"coordinates":[106.816026,-6.200878],"type":"Point"}},{"type":"Feature","properties":{"name":"Rute 2","stroke":"#b88e65","stroke-width":5},"geometry":{"type":"LineString","coordinates":[[106.813702,-6.204638],[106.813805,-6.205341],[106.81363,-6.205367],[106.813738,-6.206453],[106.812156,-6.206538],[106.81215,-6.206786],[106.811999,-6.206782],[106.811852,-6.206801],[106.811719,-6.206833],[106.81159,-6.206861],[106.811455,-6.206935],[106.811597,-6.20718],[106.811888,-6.207555],[106.812000,-6.207673],[106.812054,-6.207826],[106.81209,-6.207919],[106.812121,-6.208186],[106.812658,-6.20874],[106.812383,-6.208797],[106.812039,-6.208974],[106.811854,-6.208704]]}},{"type":"Feature","properties":{"name":"Rute 1","stroke":"#ffd700","stroke-width":5},"geometry":{"type":"LineString","coordinates":[[106.811846,-6.208722],[106.811903,-6.208787],[106.812029,-6.208984],[106.812096,-6.209147],[106.812267,-6.209681],[106.812302,-6.209877],[106.812332,-6.210125],[106.812331,-6.21057],[106.812264,-6.211546],[106.812245,-6.21192],[106.811124,-6.212038],[106.811207,-6.213286],[106.811252,-6.213486],[106.811628,-6.214192],[106.8118,-6.214465],[106.812013,-6.214925],[106.812169,-6.215214],[106.812159,-6.215244],[106.812138,-6.215271],[106.812106,-6.215299],[106.812254,-6.215982],[106.813337,-6.215834],[106.813581,-6.216337],[106.813604,-6.216368],[106.813658,-6.216408],[106.81367,-6.21642],[106.813408,-6.216633]]}},{"type":"Feature","properties":{"name":"START: Taman Sentra BRI"},"geometry":{"coordinates":[106.813538,-6.216808],"type":"Point"}},{"type":"Feature","properties":{"name":"Jakarta Notebook","marker-color":"#ff0000"},"geometry":{"coordinates":[106.811764,-6.208786],"type":"Point"}}]};

        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

        // ... (Fungsi kalkulasi jarak dan GeoJSON layer tetap sama) ...
        function calculateLineStringLength(coordinates){let t=0;for(let o=0;o<coordinates.length-1;o++){let[e,r]=coordinates[o],[a,n]=coordinates[o+1];t+=haversineDistance(r,e,n,a)}return t}function haversineDistance(t,o,e,r){const a=6371,n=(t-e)*Math.PI/180,i=(o-r)*Math.PI/180,c=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return a*2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))}
        let totalLength=0;geojsonData.features.forEach(f=>{if(f.geometry.type==='LineString'&&f.properties.name&&f.properties.name.startsWith('Rute')){totalLength+=calculateLineStringLength(f.geometry.coordinates)}});document.getElementById('totalRouteLength').textContent=totalLength.toFixed(2);
        const geoJsonLayer = L.geoJSON(geojsonData, {style:f=>({color:f.properties.stroke||'#3388ff',weight:f.properties['stroke-width']||3}),onEachFeature:(f,l)=>{const p=f.properties;if(p&&p.name){let t=p.name;if(f.geometry.type==='LineString'){const len=calculateLineStringLength(f.geometry.coordinates);t+=`<br><b>Jarak: ${len.toFixed(2)} km</b>`}l.bindTooltip(t,{sticky:true})}},pointToLayer:(f,l)=>{const p=f.properties;if(p&&p.name&&(p.name.startsWith('START')||p.name.startsWith('FINISH'))){return L.marker(l)}if(p&&p['marker-color']){const i=L.divIcon({className:'custom-div-icon',html:`<div style="background-color:${p['marker-color']};width:15px;height:15px;border-radius:50%;border:2px solid white;"></div>`});return L.marker(l,{icon:i})}return L.marker(l)}}).addTo(map);
        let startCoords, finishCoords; geojsonData.features.forEach(f=>{if(f.properties.name&&f.properties.name.startsWith('START')){startCoords=[f.geometry.coordinates[1],f.geometry.coordinates[0]]}if(f.properties.name&&f.properties.name.startsWith('FINISH')){finishCoords=[f.geometry.coordinates[1],f.geometry.coordinates[0]]}});if(startCoords&&finishCoords){map.fitBounds(L.latLngBounds([startCoords,finishCoords]).pad(0.15))}else{map.fitBounds(geoJsonLayer.getBounds().pad(0.1))}

        // --- FUNGSI LOKASI PENGGUNA (DIREVISI) ---
        L.Control.Custom = L.Control.extend({
            onAdd: function(map) {
                const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                const b = L.DomUtil.create('button', '', c);
                b.innerHTML = '📍'; b.title = 'Cari lokasi saya';
                L.DomEvent.disableClickPropagation(b).on(b, 'click', () => {
                    map.locate({setView: true, maxZoom: 17, enableHighAccuracy: true});
                });
                return c;
            }
        });
        new L.Control.Custom({ position: 'topleft' }).addTo(map);

        let userMarker, userCircle;
        map.on('locationfound', function(e) {
            if (userMarker) map.removeLayer(userMarker);
            if (userCircle) map.removeLayer(userCircle);
            const radius = e.accuracy / 2;
            userMarker = L.marker(e.latlng).addTo(map).bindPopup(`Akurasi: ${radius.toFixed(0)} meter`).openPopup();
            userCircle = L.circle(e.latlng, radius).addTo(map);
        });

        // REVISI: Penanganan Error yang Lebih Informatif
        map.on('locationerror', function(e) {
            let message = "";
            switch (e.code) {
                case 0:
                    message = "Gagal mendapatkan lokasi. Terjadi kesalahan yang tidak diketahui.";
                    break;
                case 1:
                    message = "Akses lokasi ditolak oleh Anda. Silakan reset izin lokasi untuk situs ini di pengaturan browser Anda.";
                    break;
                case 2:
                    message = "Posisi tidak tersedia. Pastikan GPS Anda memiliki sinyal yang baik (coba di luar ruangan).";
                    break;
                case 3:
                    message = "Waktu habis saat mencoba mendapatkan lokasi. Silakan coba lagi.";
                    break;
            }
            alert(message);
        });
    </script>
</body>
</html>

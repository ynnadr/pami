<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAMI Thursday Walk - Karet Bivak</title>

    <!-- Memuat library Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Memuat library Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        /* Desain Mobile-First */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }

        #header {
            background-color: #f8f8f8;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            flex-shrink: 0;
        }

        #header h1 { margin: 0 0 5px 0; font-size: 1.4em; color: #2c3e50; }
        #header p { margin: 0 0 3px 0; font-size: 0.9em; color: #7f8c8d; }
        #totalRouteLength { font-weight: bold; color: #e67e22; }

        #map {
            flex-grow: 1;
            width: 100vw;
            z-index: 1;
            background-color: #e0e0e0;
        }

        /* Style untuk popup */
        .leaflet-popup-content-wrapper { border-radius: 5px; }
        .leaflet-popup-content p { margin: 0.5em 0; }
        .popup-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: #2c3e50; }
        
        /* Style untuk tooltip */
        .leaflet-tooltip {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-weight: bold;
            padding: 6px 10px;
        }

        /* Style untuk tombol custom lokasi */
        .leaflet-control-custom button {
            background-color: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            width: 30px;
            height: 30px;
            font-size: 1.4em;
            line-height: 26px; /* Sesuaikan agar ikon di tengah */
            text-align: center;
            cursor: pointer;
        }
        .leaflet-control-custom button:hover {
            background-color: #f4f4f4;
        }

        /* Media query untuk layar lebih besar */
        @media (min-width: 768px) {
            #header h1 { font-size: 1.8em; }
            #header p { font-size: 1em; }
        }
    </style>
</head>
<body>

    <div id="header">
        <h1>PAMI Thursday Walk</h1>
        <p>11 September 2025 - Start at 7:30am</p>
        <p>Total route (est): <span id="totalRouteLength">Menghitung...</span> km.</p>
    </div>

    <div id="map"></div>

    <script>
        // Data GeoJSON
        const geojsonData = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"Pintu belakang TPU Karet Bivak","marker-color":"#ff0000"},"geometry":{"coordinates":[106.81368714559835,-6.204650739325302],"type":"Point"}},{"type":"Feature","properties":{"name":"Rute 3","stroke":"#808000","stroke-width":5},"geometry":{"coordinates":[[106.815989,-6.200866],[106.81516,-6.200669],[106.815189,-6.201403],[106.815307,-6.201449],[106.815404,-6.201531],[106.815465,-6.201641],[106.815999,-6.203356],[106.815773,-6.203378],[106.815561,-6.203375]],"type":"LineString"}},{"type":"Feature","properties":{"name":"Gerbang TPU Karet Bivak","marker-color":"#ff0000"},"geometry":{"coordinates":[106.815669,-6.203325],"type":"Point"}},{"type":"Feature","properties":{"name":"FINISH: Stasiun Karet"},"geometry":{"coordinates":[106.816026,-6.200878],"type":"Point"}},{"type":"Feature","properties":{"name":"Rute 2","stroke":"#b88e65","stroke-width":5},"geometry":{"coordinates":[[106.813702,-6.204638],[106.813805,-6.205341],[106.81363,-6.205367],[106.813738,-6.206453],[106.812156,-6.206538],[106.81215,-6.206786],[106.811999,-6.206782],[106.811852,-6.206801],[106.811719,-6.206833],[106.81159,-6.206861],[106.811455,-6.206935],[106.811597,-6.20718],[106.811888,-6.207555],[106.812000,-6.207673],[106.812054,-6.207826],[106.81209,-6.207919],[106.812121,-6.208186],[106.812658,-6.20874],[106.812383,-6.208797],[106.812039,-6.208974],[106.811854,-6.208704]],"type":"LineString"}},{"type":"Feature","properties":{"name":"Rute 1","stroke":"#ffd700","stroke-width":5},"geometry":{"coordinates":[[106.811846,-6.208722],[106.811903,-6.208787],[106.812029,-6.208984],[106.812096,-6.209147],[106.812267,-6.209681],[106.812302,-6.209877],[106.812332,-6.210125],[106.812331,-6.21057],[106.812264,-6.211546],[106.812245,-6.21192],[106.811124,-6.212038],[106.811207,-6.213286],[106.811252,-6.213486],[106.811628,-6.214192],[106.8118,-6.214465],[106.812013,-6.214925],[106.812169,-6.215214],[106.812159,-6.215244],[106.812138,-6.215271],[106.812106,-6.215299],[106.812254,-6.215982],[106.813337,-6.215834],[106.813581,-6.216337],[106.813604,-6.216368],[106.813658,-6.216408],[106.81367,-6.21642],[106.813408,-6.216633]],"type":"LineString"}},{"type":"Feature","properties":{"name":"START: Taman Sentra BRI"},"geometry":{"coordinates":[106.813538,-6.216808],"type":"Point"}},{"type":"Feature","properties":{"name":"Jakarta Notebook","marker-color":"#ff0000"},"geometry":{"coordinates":[106.811764,-6.208786],"type":"Point"}},{"type":"Feature","properties":{},"geometry":{"coordinates":[[[106.815552,-6.203331],[106.815577,-6.203331],[106.815577,-6.202891],[106.815552,-6.202891],[106.815552,-6.203331]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"TPU Karet Bivak","note":"TPU Karet Bivak merupakan tempat peristirahatan akhir bagi banyak tokoh bangsa..."},"geometry":{"coordinates":[[[106.81549,-6.203305],[106.8155,-6.202681],[106.815336,-6.201996],[106.815233,-6.201731],[106.815099,-6.201639],[106.814904,-6.201567],[106.813855,-6.201444],[106.813454,-6.201455],[106.811562,-6.201649],[106.811459,-6.202047],[106.811531,-6.202201],[106.811747,-6.202303],[106.811922,-6.202395],[106.812004,-6.202773],[106.811891,-6.203366],[106.811912,-6.20353],[106.811984,-6.203683],[106.811994,-6.203816],[106.812045,-6.203949],[106.81223,-6.204082],[106.812487,-6.204235],[106.812971,-6.204358],[106.813495,-6.204409],[106.814122,-6.204419],[106.81477,-6.204358],[106.815696,-6.204317],[106.81549,-6.203305]]],"type":"Polygon"}}]};

        // Inisialisasi Peta
        const map = L.map('map');

        // Tambahkan Tile Layer (Peta Dasar)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Fungsi Kalkulasi Jarak
        function toRadians(deg) { return deg * Math.PI / 180; }
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function calculateLineStringLength(coordinates) {
            let totalLength = 0;
            for (let i = 0; i < coordinates.length - 1; i++) {
                const [lon1, lat1] = coordinates[i];
                const [lon2, lat2] = coordinates[i + 1];
                totalLength += haversineDistance(lat1, lon1, lat2, lon2);
            }
            return totalLength;
        }

        // Hitung total panjang rute dan perbarui header
        let totalEstimatedRouteLength = 0;
        geojsonData.features.forEach(feature => {
            if (feature.geometry.type === 'LineString' && feature.properties.name && feature.properties.name.startsWith('Rute')) {
                totalEstimatedRouteLength += calculateLineStringLength(feature.geometry.coordinates);
            }
        });
        document.getElementById('totalRouteLength').textContent = totalEstimatedRouteLength.toFixed(2);
        
        // Tambahkan GeoJSON Layer ke Peta
        const geoJsonLayer = L.geoJSON(geojsonData, {
            style: feature => ({
                color: feature.properties.stroke || '#3388ff',
                weight: feature.properties['stroke-width'] || 3,
                opacity: feature.properties['stroke-opacity'] || 1.0,
                fillColor: feature.properties.fill || '#3388ff',
                fillOpacity: feature.properties['fill-opacity'] || 0.2
            }),
            onEachFeature: function (feature, layer) {
                const props = feature.properties;
                if (props) {
                    let popupContent = '';
                    if (props.name) popupContent += `<div class="popup-title">${props.name}</div>`;
                    if (props.note) popupContent += `<p>${props.note}</p>`;
                    if (popupContent) layer.bindPopup(popupContent);
                }
                if (props && props.name) {
                    let tooltipContent = props.name;
                    if (feature.geometry.type === 'LineString') {
                        const length = calculateLineStringLength(feature.geometry.coordinates);
                        tooltipContent += `<br><b>Jarak: ${length.toFixed(2)} km</b>`;
                    }
                    layer.bindTooltip(tooltipContent, { sticky: true });
                }
            },
            pointToLayer: function (feature, latlng) {
                const props = feature.properties;
                if (props && props.name && (props.name.startsWith('START') || props.name.startsWith('FINISH'))) {
                    return L.marker(latlng);
                }
                if (props && props['marker-color']) {
                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${props['marker-color']}; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    return L.marker(latlng, { icon: customIcon });
                }
                return L.marker(latlng);
            }
        }).addTo(map);

        // Atur Tampilan Peta Awal
        let startCoords, finishCoords;
        geojsonData.features.forEach(feature => {
            if (feature.properties.name && feature.properties.name.startsWith('START')) {
                startCoords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            }
            if (feature.properties.name && feature.properties.name.startsWith('FINISH')) {
                finishCoords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            }
        });
        
        if (startCoords && finishCoords) {
            const bounds = L.latLngBounds([startCoords, finishCoords]);
            map.fitBounds(bounds.pad(0.15)); 
        } else {
            map.fitBounds(geoJsonLayer.getBounds().pad(0.1));
        }

        // --- FUNGSI LOKASI PENGGUNA ---
        
        // Buat custom control button
        L.Control.Custom = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                const btn = L.DomUtil.create('button', '', container);
                btn.innerHTML = 'üìç'; // Ikon target sebagai tombol
                btn.title = 'Cari lokasi saya';
                L.DomEvent.disableClickPropagation(btn);
                
                L.DomEvent.on(btn, 'click', function() {
                    map.locate({setView: true, maxZoom: 17, enableHighAccuracy: true});
                });

                return container;
            }
        });
        new L.Control.Custom({ position: 'topleft' }).addTo(map);

        // Variabel global untuk menyimpan marker & lingkaran pengguna
        let userLocationMarker, userLocationAccuracyCircle;

        // Event handler saat lokasi berhasil ditemukan
        map.on('locationfound', function(e) {
            if (userLocationMarker) map.removeLayer(userLocationMarker);
            if (userLocationAccuracyCircle) map.removeLayer(userLocationAccuracyCircle);
            
            const radius = e.accuracy / 2;
            userLocationMarker = L.marker(e.latlng).addTo(map)
                .bindPopup(`Anda berada sekitar ${radius.toFixed(0)} meter dari titik ini`).openPopup();
            userLocationAccuracyCircle = L.circle(e.latlng, radius).addTo(map);
        });

        // Event handler jika gagal menemukan lokasi
        map.on('locationerror', function(e) {
            alert("Gagal menemukan lokasi Anda. Pastikan GPS aktif dan Anda telah memberikan izin lokasi pada browser.\n\nError: " + e.message);
        });

    </script>

</body>
</html>
